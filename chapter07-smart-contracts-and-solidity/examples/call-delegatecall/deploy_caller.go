// +build ignore

package main

import (
	"context"
	"encoding/hex"
	"fmt"
	"math/big"

	"github.com/ethereum/go-ethereum/core/types"
	"github.com/sammyne/mastering-ethereum/playground/eth"
)

func main() {
	c, err := eth.Dial()
	if nil != err {
		panic(err)
	}
	defer c.Close()

	gasPrice, err := c.SuggestGasPrice(context.TODO())
	if nil != err {
		panic(err)
	}

	const (
		nonce    = 21
		gasLimit = 2000000
	)

	var (
		ropstenChainID = big.NewInt(3)
		code, _        = hex.DecodeString(`608060405234801561001057600080fd5b5061034e806100206000396000f3fe608060405234801561001057600080fd5b506004361061002b5760003560e01c8063444c35df14610030575b600080fd5b6100566004803603602081101561004657600080fd5b50356001600160a01b0316610058565b005b806001600160a01b0316630d8ea1806040518163ffffffff1660e01b8152600401600060405180830381600087803b15801561009357600080fd5b505af11580156100a7573d6000803e3d6000fd5b5050505073dbd808691caed7420134e4fc645d9f5536b82afc630d8ea1806040518163ffffffff1660e01b815260040160006040518083038186803b1580156100ef57600080fd5b505af4158015610103573d6000803e3d6000fd5b505060408051600481526024810182526020810180516001600160e01b0316600160e71b621b1d430217815291518151919450600093506060926001600160a01b0387169286929182918083835b602083106101705780518252601f199092019160209182019101610151565b6001836020036101000a0380198251168184511680821785525050505050509050019150506000604051808303816000865af19150503d80600081146101d2576040519150601f19603f3d011682016040523d82523d6000602084013e6101d7565b606091505b5091509150816102225760408051600160e51b62461bcd02815260206004820152600b6024820152600160aa1b6a18d85b1b0819985a5b195902604482015290519081900360640190fd5b836001600160a01b0316836040518082805190602001908083835b6020831061025c5780518252601f19909201916020918201910161023d565b6001836020036101000a038019825116818451168082178552505050505050905001915050600060405180830381855af49150503d80600081146102bc576040519150601f19603f3d011682016040523d82523d6000602084013e6102c1565b606091505b5090925090508161031c5760408051600160e51b62461bcd02815260206004820152601360248201527f64656c656761746563616c6c206661696c656400000000000000000000000000604482015290519081900360640190fd5b5050505056fea165627a7a72305820a021eaceb6eb2a86920c0fe7e37e4b3a3b492ee3ac9dd18f2107d9c7695d43d40029`)
	)

	// TODO: compare with NewTransaction
	tx := types.NewContractCreation(nonce, eth.ToWei(0), gasLimit, gasPrice, code)

	store, accounts, err := eth.UnlockAccounts(eth.DefaultKeyDir(),
		eth.DefaultPassphrase())
	if nil != err {
		panic(err)
	}

	account := accounts[0]
	if tx, err = store.SignTx(account, tx, ropstenChainID); nil != err {
		panic(err)
	}

	if err := c.SendTransaction(context.TODO(), tx); nil != err {
		panic(err)
	}

	fmt.Println("gasPrice =", gasPrice)
	fmt.Println(" account =", account.Address.Hex())
	fmt.Println("  txHash =", tx.Hash().Hex())
}
